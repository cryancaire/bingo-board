<!DOCTYPE html>
<html>

<head>
    <title>Bingo Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
            background-color: #f4f4f9;
            color: #333;
        }

        h1,
        h2 {
            color: #2c3e50;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        button {
            cursor: pointer;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        input[type="text"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }

        .hidden {
            display: none;
        }

        .board-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .board-card {
            border: 1px solid #ddd;
            padding: 1rem;
            border-radius: 8px;
            background: #fff;
            transition: transform 0.2s;
        }

        .board-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .board-card h3 {
            margin-top: 0;
        }

        .board-actions {
            margin-top: 10px;
            display: flex;
            gap: 5px;
        }

        .auth-container {
            text-align: center;
            margin-top: 50px;
        }

        .logout-btn {
            float: right;
            background: #95a5a6;
        }

        .item-row {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
            align-items: center;
        }

        .item-row input {
            flex-grow: 1;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 1rem;
            color: #7f8c8d;
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>

    <div id="auth-view" class="container auth-container hidden">
        <h1>Welcome to Bingo Maker</h1>
        <p>Sign in to create and manage your bingo boards.</p>
        <button onclick="signInWithGoogle()" class="btn-primary">Sign in with Google</button>
    </div>

    <div id="dashboard-view" class="container hidden">
        <button onclick="signOut()" class="logout-btn">Sign Out</button>
        <h1>My Boards</h1>

        <div style="margin-bottom: 2rem;">
            <h2>Create New Board</h2>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="new-board-title" placeholder="Board Title (e.g. 'RPG ClichÃ©s')">
                <button onclick="createBoard()" class="btn-success">Create</button>
            </div>
        </div>

        <div id="boards-list" class="board-list">
            <!-- Boards will be populated here -->
        </div>
    </div>

    <div id="editor-view" class="container hidden">
        <a href="#" onclick="showDashboard()" class="back-link">&larr; Back to Dashboard</a>
        <h1 id="editor-title">Edit Board</h1>

        <div class="add-form" style="margin-bottom: 20px;">
            <form id="add-item-form" style="display: flex; gap: 10px;">
                <input type="text" id="new-item-text" placeholder="Add new bingo item..." required>
                <button type="submit" class="btn-primary">Add</button>
            </form>
        </div>

        <div id="items-list">
            <!-- Items loaded here -->
        </div>
    </div>

    <script>
        const supabaseUrl = '<%= supabaseUrl %>';
        const supabaseKey = '<%= supabaseKey %>';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        let currentUser = null;
        let currentBoardId = null;

        // Auth Logic
        async function checkUser() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                showDashboard();
                loadBoards();
            } else {
                document.getElementById('auth-view').classList.remove('hidden');
            }

            supabaseClient.auth.onAuthStateChange((_event, session) => {
                if (session) {
                    currentUser = session.user;
                    showDashboard();
                    loadBoards();
                } else {
                    currentUser = null;
                    showAuth();
                }
            });
        }

        async function signInWithGoogle() {
            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
            });
            if (error) alert(error.message);
        }

        async function signOut() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) alert(error.message);
            location.reload();
        }

        // View Management
        function showAuth() {
            hideAll();
            document.getElementById('auth-view').classList.remove('hidden');
        }

        function showDashboard() {
            hideAll();
            document.getElementById('dashboard-view').classList.remove('hidden');
        }

        function showEditor(boardId, title) {
            hideAll();
            document.getElementById('editor-view').classList.remove('hidden');
            document.getElementById('editor-title').innerText = `Edit: ${title}`;
            currentBoardId = boardId;
            loadItems(boardId);
        }

        function hideAll() {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('editor-view').classList.add('hidden');
        }

        // Board Management
        async function loadBoards() {
            const { data, error } = await supabaseClient
                .from('bingo_boards')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error(error);
                return;
            }

            const list = document.getElementById('boards-list');
            list.innerHTML = '';
            data.forEach(board => {
                const card = document.createElement('div');
                card.className = 'board-card';
                card.innerHTML = `
                    <h3>${board.title}</h3>
                    <div class="board-actions">
                        <button class="btn-primary" onclick="showEditor('${board.id}', '${board.title.replace(/'/g, "\\'")}')">Edit Items</button>
                        <a href="/board/${board.id}" target="_blank" class="btn-success" style="text-decoration:none; padding: 10px 20px; border-radius: 4px; display:inline-block; font-size: 1rem;">View / Play</a>
                        <button class="btn-danger" onclick="deleteBoard('${board.id}')">Delete</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        async function createBoard() {
            const titleInput = document.getElementById('new-board-title');
            const title = titleInput.value;
            if (!title) return alert("Please enter a title");

            const { data, error } = await supabaseClient
                .from('bingo_boards')
                .insert([{ title: title, user_id: currentUser.id }])
                .select();

            if (error) {
                alert("Error creating board: " + error.message);
            } else {
                titleInput.value = '';
                loadBoards();
            }
        }

        async function deleteBoard(id) {
            if (!confirm("Are you sure? This will delete the board and all its items.")) return;

            const { error } = await supabaseClient
                .from('bingo_boards')
                .delete()
                .eq('id', id);

            if (error) alert("Error deleting board: " + error.message);
            else loadBoards();
        }

        // Item Management
        async function loadItems(boardId) {
            const list = document.getElementById('items-list');
            list.innerHTML = 'Loading...';

            const { data, error } = await supabaseClient
                .from('bingo_items')
                .select('*')
                .eq('board_id', boardId);

            if (error) {
                list.innerText = "Error loading items.";
                return;
            }

            list.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('div');
                row.className = 'item-row';

                const input = document.createElement('input');
                input.type = 'text';
                input.value = item.text;

                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'Save';
                saveBtn.className = 'btn-success';
                saveBtn.onclick = () => updateItem(item.id, input.value, saveBtn);

                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.className = 'btn-danger';
                delBtn.onclick = () => deleteItem(item.id);

                row.append(input, saveBtn, delBtn);
                list.appendChild(row);
            });
        }

        async function updateItem(id, text, btn) {
            const { error } = await supabaseClient
                .from('bingo_items')
                .update({ text })
                .eq('id', id);

            if (error) alert("Error updating: " + error.message);
            else {
                const originalText = btn.textContent;
                btn.textContent = 'Saved!';
                setTimeout(() => btn.textContent = originalText, 1000);
            }
        }

        async function deleteItem(id) {
            if (!confirm("Delete item?")) return;
            const { error } = await supabaseClient
                .from('bingo_items')
                .delete()
                .eq('id', id);

            if (error) alert("Error: " + error.message);
            else loadItems(currentBoardId);
        }

        document.getElementById('add-item-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('new-item-text');
            const text = input.value;

            const { error } = await supabaseClient
                .from('bingo_items')
                .insert([{ board_id: currentBoardId, text: text }]);

            if (error) alert("Error adding item: " + error.message);
            else {
                input.value = '';
                loadItems(currentBoardId);
            }
        };

        // Init
        checkUser();
    </script>
</body>

</html>